#!/bin/bash

PWD=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

IMAGE_TO_CHECK=$1
SEARCH_TERMS=$2
PULL_SECRETS_FILE=${PULL_SECRET:-$HOME/pull-secret.txt}
GREP_PATTERN=$(echo "${SEARCH_TERMS}" | tr ',' '|')
SHELL_CMD="rpm -qa | grep -Ei '${GREP_PATTERN}'"

echo "Searching CPO image"
HYPERSHIFT_IMAGE=$(oc adm release info "${IMAGE_TO_CHECK}" -a "${PULL_SECRETS_FILE}" --pullspecs | grep hypershift | awk '{print $2}')
podman pull --tls-verify=false "${HYPERSHIFT_IMAGE}" --authfile "${PULL_SECRETS_FILE}" --quiet
podman run -it --entrypoint=sh "${HYPERSHIFT_IMAGE}" -c "${SHELL_CMD}"